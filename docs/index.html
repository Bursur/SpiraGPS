<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <title>Spira GPS</title>
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
    <script type="application/javascript" src="skiko.js"></script>
    <script type="application/javascript" src="webApp.js"></script>
    <script>
        function saveDarkModePreference(enabled) {
            localStorage.darkMode = enabled;
        }

        function getDarkModePreference() {
            if(localStorage.darkMode)
                return Number(localStorage.darkMode);

            return 0
        }

        function saveTextSizePreference(size) {
            localStorage.textSize = size;
        }

        function getTextSizePreference() {
            if(localStorage.textSize)
                return Number(localStorage.textSize);

            return 0
        }

        function saveDyslexicModePreference(enabled) {
            localStorage.dyslexicMode = enabled;
        }

        function getDyslexicModePreference() {
            if(localStorage.dyslexicMode)
                return Number(localStorage.dyslexicMode);

            return 0
        }

        var data = "#DEADFACE";
        function getLoadedData() {
            return data;
        }

        function openFile() {
            data = "#DEADFACE";
            const fileInputElement = document.createElement('input');
            fileInputElement.type = 'file';
            fileInputElement.style.opacity = '0';
            fileInputElement.accept = "application/JSON";
            fileInputElement.addEventListener('change', () => {
                const file = fileInputElement.files[0];
                console.log('File "' + file.name + '" selected.');

                var reader = new FileReader();
                reader.onload = readerEvent => {
                    var content = readerEvent.target.result;
                    data = content
                }
                reader.readAsText(file, 'UTF-8');

                document.body.removeChild(fileInputElement);
            });
            document.body.appendChild(fileInputElement);
            setTimeout(_ => {
                fileInputElement.click();
                const onFocus = () => {
                    window.removeEventListener('focus', onFocus);
                    document.body.addEventListener('mousemove', onMouseMove);
                };
                const onMouseMove = () => {
                    document.body.removeEventListener('mousemove', onMouseMove);
                    if (!fileInputElement.files.length) {
                        document.body.removeChild(fileInputElement);
                        console.log('No file selected.');
                        data = "cancelled";
                    }
                }
                window.addEventListener('focus', onFocus);
            }, 0);
        }
    </script>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: white;
            overflow: hidden;
        }

        #warning {
            position: absolute;
            top: 100px;
            left: 100px;
            max-width: 830px;
            z-index: 100;
            background-color: white;
            font-size: initial;
            display: none;
        }
        #warning li {
            padding-bottom: 15px;
        }

        #warning span.code {
            font-family: monospace;
        }

        ul {
            margin-top: 0;
            margin-bottom: 15px;
        }

        #footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            z-index: 1000;
            background-color: white;
            font-size: initial;
        }

        #close {
            position: absolute;
            top: 0;
            right: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
<canvas id="ComposeTarget"></canvas>
</body>

<script type="application/javascript" >
    const unhandledError = (event, error) => {
        if (error instanceof WebAssembly.CompileError) {
            document.getElementById("warning").style.display="initial";

            // Hide a Scary Webpack Overlay which is less informative in this case.  
            const webpackOverlay = document.getElementById("webpack-dev-server-client-overlay");
            if (webpackOverlay != null) webpackOverlay.style.display="none";
        }
    }
    addEventListener("error", (event) => unhandledError(event, event.error));
    addEventListener("unhandledrejection", (event) => unhandledError(event, event.reason));
</script>

</html>
